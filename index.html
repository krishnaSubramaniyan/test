<!DOCTYPE html>
<html>
  <body>
    <h3>Current Time:</h3>
    <pre id="output">Loading...</pre>
    <script>
      var data = null;
      let yearData = JSON.parse(localStorage.getItem('yearData'));
      const sysDateTime = new Date();

      if(!yearData || (sysDateTime.getTime() > yearData.expiry)){
	  fetchYear("http://worldtimeapi.org/api/timezone/Asia/Kolkata");
      }
      else{
	  document.getElementById("output").textContent = yearData.year;
      }
      
      async function fetchYear(endpoint) {
	  var requestCount = 0;
	  while (data == null) {
              try {
		  if(requestCount > 200){
		      break;
		  }
		  const res = await fetch(endpoint);
		  data  = await res.json();
		  let year = new Date(data.datetime).getFullYear();
		 
		  console.log(res);
		  console.log(data);
		  document.getElementById("output").textContent = year;
		  localStorage.removeItem('yearData');
		  const obj = {
		      year   : year,
		      expiry : (sysDateTime.getTime()+(24*60*60*1000)) //expiry time is one-day
		  }
		  localStorage.setItem('yearData',JSON.stringify(obj));
		  break;

              } catch (e) {
		  requestCount++;
	      }

	      if(data == null){
		  const year = new Date().getFullYear();
		  document.getElementById("output").textContent = year;
		  localStorage.removeItem('yearData');
		  const obj = {
		      year   : year,
		      expiry : (sysDateTime.getTime()+(24*60*60*1000)) //expiry time is one-day
		  }
		  localStorage.setItem('yearData',JSON.stringify(obj));
		  
	      }
	  }
      }
      
    </script>
  </body>
</html>
