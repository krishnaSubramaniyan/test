<!DOCTYPE html>
<html>
  <body>
    <h3>Current Time:</h3>
    <pre id="output">Loading...</pre>
    <iframe width="560" height="315" src="https://www.youtube-nocookie.com/embed/es5ThfPNokI?si=vr4Cv8gUSAnBFSzr" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
    <script>
      let isRunning = false; // Prevent concurrent fetches

      // Check if cached data exists and is valid
      const cached = JSON.parse(localStorage.getItem("yearData"));
      const now = new Date().getTime();

      if (!cached || now > cached.expiry) {
        fetchYear("http://worldtimeapi.org/api/timezone/Asia/Kolkata");
      } else {
        document.getElementById("output").textContent = cached.year;
      }

      async function fetchYear(endpoint) {
        if (isRunning) return;
        isRunning = true;

        const fallbackYear = new Date().getFullYear();
        let attempt = 0;
        const maxAttempts = 200;

        try {
          while (attempt < maxAttempts) {
            attempt++;
            try {
              console.log(`Attempt ${attempt}`);

              const controller = new AbortController();
              const timeout = setTimeout(() => controller.abort(), 2000);

              const response = await fetch(endpoint, {
                method: "GET",
                signal: controller.signal
              });

              clearTimeout(timeout);

              if (!response.ok) {
                throw new Error("Bad HTTP response: " + response.status);
              }

              const data = await response.json();
              const year = new Date(data.datetime).getFullYear();

              updateYear(year);
              console.log(`Success on attempt ${attempt}`);
              return;
            } catch (err) {
              console.warn(`Attempt ${attempt} failed: ${err.message}`);
              await new Promise(res => setTimeout(res, 300)); // Wait before retry
            }
          }

          console.warn("All attempts failed. Using fallback.");
          updateYear(fallbackYear);

        } finally {
          isRunning = false;
        }
      }

      function updateYear(year) {
        document.getElementById("output").textContent = year;

        const now = new Date().getTime();
        const oneDay = 24 * 60 * 60 * 1000;
        const cacheData = {
          year: year,
          expiry: now + oneDay
        };

        localStorage.setItem("yearData", JSON.stringify(cacheData));
      }
    </script>
  </body>
</html>
